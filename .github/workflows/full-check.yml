# Copyright 2020      Daniel T. Borelli <daltomi@disroot.org>
# Copyright 2020      Jeroen Roovers <jer@gentoo.org>
# Copyright 2020      Joao Eriberto Mota Filho <eriberto@eriberto.pro.br>
# Copyright 2021-2023 Guilherme Janczak <guilherme.janczak@yandex.com>
# Copyright 2022      Zev Weiss <zev@bewilderbeest.net>
# Copyright 2023-2025 NRK <nrk@disroot.org>

name: full-check

on: [push, pull_request]

jobs:
  ubuntu:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: install_dependencies
      run: |
        sudo apt update && sudo apt upgrade
        sudo apt install tcc libimlib2-dev libxcomposite-dev libxfixes-dev \
             autoconf-archive libbsd-dev libxinerama-dev cppcheck
    - name: distcheck
      run: |
        ./autogen.sh
        ./configure SCROT_PRIVATE_FLAGS="-Werror -Wno-error=cpp -Wno-error=pedantic"
        make distcheck
    - name: run_program
      run: |
        make
        src/scrot -v
    - name: tcc
      run: |
        ./configure SCROT_PRIVATE_FLAGS="-Werror -Wno-error=cpp -Wno-error=pedantic" CC=tcc
        make clean all
        src/scrot -v
    - name: bare build
      run: |
        make -s distclean
        c99 -o src/scrot src/*.c $(pkg-config --cflags --libs ./deps.pc)
        src/scrot -v
    - name: cppcheck
      run: |
        cppcheck --version
        cppcheck --std=c99 -j$(nproc) --quiet --force --error-exitcode=1 \
            --suppress=uninitvar \
            --enable=portability,performance src/*.c \
            $(pkg-config --cflags ./deps.pc)
    - name: clang-tidy
      run: |
        clang-tidy --version
        find src -name '*.c' -print | xargs -P$(nproc) -I{} \
            clang-tidy --quiet {} -- $(pkg-config --cflags ./deps.pc)
